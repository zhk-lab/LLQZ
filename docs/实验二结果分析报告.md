# 实验二结果分析报告（PubMedQA，语义熵 SE(x) 幻觉/错误检测）

> 本报告面向论文写作：总结实验设定、统计结果与图像解读，并给出结论与局限性。  
> 对应产物：`runs/exp2/correlation_v2.json`、`plots/exp2_entropy_scatter_v2.png`、`plots/exp2_entropy_bucket_bar_v2.png`。

---

## 1. 实验目的与核心假设

实验二旨在验证：**语义熵** \(SE(x)\) 能否作为“高风险/高错误概率”的不确定性信号。直观假设为：

- 对同一问题 \(x\) 采样 \(M\) 次候选回答后，若答案语义分裂明显，则形成多个语义簇 \(c_1,\dots,c_K\)，其类分布更“均匀”，从而 \(SE(x)\) 更高。
- **\(SE(x)\) 越高，模型越可能出错**（或错误程度更高）。

---

## 2. 数据与实现设置（v2）

### 2.1 数据集

- 数据集：PubMedQA
- 题目数：`num_questions = 1000`

### 2.2 采样与聚类

- 每题采样：\(M=10\)
- 语义等价判定：`semantic_backend = nli_llm`  
  即用 LLM 进行 **双向蕴含** 近似：\(s_i \Leftrightarrow s_j\) 当且仅当 \(s_i \Rightarrow s_j\) 且 \(s_j \Rightarrow s_i\)。
- 聚类策略：**贪婪聚类**（按代表元素判等价，等价则并入，否则新建簇）
- 约束：`require_same_label = true`  
  仅在 `final_label` 相同的前提下允许并簇，避免跨标签的“语义近似”合并导致的评估歧义。

### 2.3 预测与错误度量

- 预测聚合：`prediction_mode = maybe_debiased`  
  在多数票基础上，对“边界型 maybe”进行轻量去偏（用于减少模型默认输出 maybe 的系统性偏置）。
- 主要用于相关性与作图的错误指标：`plot_error_metric = ordinal`  
  将 `no/maybe/yes` 映射为 `-1/0/1`，并以距离定义错误程度：  
  \[
  error_{ord} = \frac{|score(pred) - score(gold)|}{2} \in [0,1]
  \]

---

## 3. 统计结果（来自 `runs/exp2/correlation_v2.json`）

### 3.1 语义熵与错误的相关性

报告了 Pearson 与 Spearman 两类相关性（p-value 用于显著性检验）：

| 指标 | Pearson | p-value | Spearman | p-value |
|---|---:|---:|---:|---:|
| **Binary error（0/1）** | 0.1426 | 6.00e-06 | 0.1772 | 1.69e-08 |
| **Ordinal error（程度）** | 0.1310 | 3.24e-05 | 0.1726 | 3.96e-08 |

**解读**：

- 相关系数为正且 p-value 极小，表明：**SE(x) 与错误（以及错误程度）存在统计显著的正相关**。
- 效应量属于“中等偏弱”：\( \rho \approx 0.17 \) 说明语义熵是有效信号，但不是单独即可完美预测错误的强信号；更适合做**风险预警/触发器**。

### 3.2 标签分布与 maybe 偏置诊断

预测标签（最终预测）分布：

- `maybe_rate_final_pred = 0.612`（612/1000）
- `yes = 348`，`no = 40`

同时给出了 maybe 相关诊断：

- `maybe_overuse_rate = 0.533`  
  含义：预测为 maybe 且 gold 为 yes/no 的比例较高，说明模型仍然偏保守（但比 v1 已明显改善）。

### 3.3 错误水平（总体）

- `mean_error_binary = 0.59`（平均错误率约 59%）
- `mean_error_ordinal = 0.308`（平均错误程度约 0.308）

该结果说明：在当前模型/提示与数据设定下，任务整体仍具有挑战性；这也符合“不确定性信号难以获得极强相关”的常见现象。

### 3.4 NLI 计算成本与缓存

- `cache_miss = 20666`，`cache_hit = 3179`，`cache_size = 20666`

**解读**：

- 双向蕴含带来大量 NLI 调用（miss 即实际请求次数），是分析阶段耗时的主要来源。
- 缓存可在重复运行/调参时显著加速（尤其改动聚合策略或绘图时）。

---

## 4. 图像结果解读

### 4.1 图 1：SE(x) vs Error（散点图）

文件：`plots/exp2_entropy_scatter_v2.png`

图中：

- 横轴：语义熵 \(SE(x)\)
- 纵轴：错误程度（ordinal error；0=对，1=错得更严重）
- 深色线：线性趋势线

**主要观察**：

- 趋势线明显上升：高熵区域平均错误程度更高。
- 点云分布显示：低熵区域也存在错误，说明错误来源不完全来自“语义分裂”，还存在模型系统性偏差、证据不足等因素。

### 4.2 图 2：熵分桶（B1→B6）与错误率/标签混合

文件：`plots/exp2_entropy_bucket_bar_v2.png`

图中：

- 纵轴：熵分桶（从低熵 B1 到高熵 B6）
- 横向堆叠条：该桶内预测标签 `yes/no/maybe` 的占比
- 折线：该桶的平均错误（图上标注为 Error Rate by Entropy Bucket）

**主要观察**：

- 折线总体在高熵桶更高（尤其最高熵桶 B6），与“高熵更危险”一致。
- 标签组成在不同熵桶间发生变化：高熵区间更容易出现标签混合与不稳定预测（体现“语义分裂”）。

---

## 5. 与 v1 的对比（用于论文的 ablation 叙述）

v1（旧实现/旧提示）相关性：

- Pearson \(r \approx 0.066\)，Spearman \(\rho \approx 0.064\)（均 p≈0.04，弱相关）

v2（NLI 双向蕴含 + 去偏 + ordinal error）相关性显著提升：

- Spearman（ordinal）\(\rho \approx 0.173\)，p≈4e-08

**可能原因（可写进论文讨论）**：

- v2 采用更贴近定义的语义等价判定（双向蕴含）降低“聚类噪声”；
- error 由二值升级为 ordinal 使得“程度差异”可被捕捉；
- 采样提示更严格减少 `maybe` 的默认输出偏置，使 SE(x) 的变化空间更大，从而提升可检测性。

---

## 6. 结论（可直接用于论文）

在 PubMedQA 上，基于双向蕴含近似与贪婪聚类得到的语义熵 \(SE(x)\) 与模型错误呈显著正相关（Spearman \(\rho\approx 0.17\)，p-value \(\ll 0.001\)）。这表明语义熵能够作为回答可靠性的有效不确定性信号，可用于错误/幻觉风险预警与触发后续纠错流程（如再检索、反思、拒答等）。然而其效应量中等偏弱，说明语义熵更适合作为组合信号的一部分，而非单一判别器。

---

## 7. 局限性与改进方向（Discussion）

- **logprob 近似**：当前 \(p(c_k|x)\) 使用簇频率近似，而非基于 token logprob 的真实 \(p(s|x)\) 汇总；若推理后端支持 logprob，可进一步提升严谨性。
- **NLI judge 能力**：使用 LLM 作为 NLI 判定器会引入判定噪声；可替换为专用 NLI 模型或更强 judge 模型，并报告一致性。
- **maybe 偏置仍存在**：`maybe_overuse_rate` 仍较高，可能需要进一步校准提示或引入拒答/不确定性阈值策略。
- **数据与任务性质**：PubMedQA 本身可能存在证据不足/标注噪声，导致任何不确定性指标的上界受限。

